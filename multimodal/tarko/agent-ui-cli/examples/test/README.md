# Agent Trace Transformer

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•å°† `agent_trace.jsonl` æ–‡ä»¶è½¬æ¢ä¸º AgentEventStream æ ¼å¼ï¼Œå¹¶ç”Ÿæˆå¯è§†åŒ–çš„ HTML æŠ¥å‘Šã€‚

## æ–‡ä»¶è¯´æ˜

- `agent_trace.jsonl` - æºæ•°æ®æ–‡ä»¶ï¼ˆOpenTelemetry é£æ ¼çš„ span äº‹ä»¶ï¼‰
- `transformer.ts` - ä¸»è¦çš„è½¬æ¢å™¨å®ç°
- `test-transformer.ts` - æµ‹è¯•è„šæœ¬
- `dump-html.ts` - HTML å¯è§†åŒ–ç”Ÿæˆå™¨
- `event-stream-comparison.md` - è¯¦ç»†çš„åè®®å¯¹æ¯”åˆ†ææ–‡æ¡£
- `analyze_*.js` - æ•°æ®åˆ†æè„šæœ¬

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. åˆ†ææºæ•°æ®

```bash
# åˆ†ææ•´ä½“æ¨¡å¼
npm run analyze

# åˆ†æç‰¹å®šè¡Œ
node analyze_trace.js 3
node detailed_analyze.js 3
```

### 3. æµ‹è¯•è½¬æ¢å™¨

```bash
npm test
```

è¿™ä¼šï¼š
- è¯»å– `agent_trace.jsonl`
- è½¬æ¢ä¸º AgentEventStream äº‹ä»¶
- è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
- ä¿å­˜ç»“æœåˆ° `transformed_events.json`

### 4. ç”Ÿæˆ HTML å¯è§†åŒ–

```bash
npm run dump
```

è¿™ä¼šç”Ÿæˆ `agent_trace_visualization.html` æ–‡ä»¶ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å³å¯æŸ¥çœ‹å¯è§†åŒ–ç»“æœã€‚

## è½¬æ¢å™¨åŠŸèƒ½

### æ”¯æŒçš„äº‹ä»¶ç±»å‹è½¬æ¢

| æºæ•°æ® | ç›®æ ‡äº‹ä»¶ç±»å‹ | è¯´æ˜ |
|--------|-------------|------|
| `llm` span with content | `assistant_message` | LLM å“åº”æ¶ˆæ¯ |
| `llm` span with `<function=think>` | `assistant_thinking_message` | æ€è€ƒè¿‡ç¨‹ |
| `parse_tool_calls` span | `tool_call` | å·¥å…·è°ƒç”¨ |
| `portal.run_action` span | `tool_result` | å·¥å…·æ‰§è¡Œç»“æœ |
| `agent_step` start | `agent_run_start` | ä»£ç†æ‰§è¡Œå¼€å§‹ |
| `agent_step` end | `agent_run_end` | ä»£ç†æ‰§è¡Œç»“æŸ |

### Function Call è§£æ

è½¬æ¢å™¨èƒ½å¤Ÿè§£ææºæ•°æ®ä¸­çš„ç‰¹æ®Šæ ¼å¼ï¼š

```
<function=execute_bash>
<parameter=command>pwd && ls</parameter>
</function>
```

è½¬æ¢ä¸ºæ ‡å‡†çš„ `ChatCompletionMessageToolCall` æ ¼å¼ï¼š

```json
{
  "id": "tool-call-123",
  "type": "function",
  "function": {
    "name": "execute_bash",
    "arguments": "{\"command\": \"pwd && ls\"}"
  }
}
```

### äº‹ä»¶å…³è”

- é€šè¿‡ `span_id` å’Œ `parent_span_id` å»ºç«‹äº‹ä»¶å…³è”
- ç”Ÿæˆå”¯ä¸€çš„ `toolCallId` å…³è”å·¥å…·è°ƒç”¨å’Œç»“æœ
- ç»´æŠ¤æ—¶åºå…³ç³»å’Œæ¶ˆæ¯ ID

## HTML å¯è§†åŒ–åŠŸèƒ½

ç”Ÿæˆçš„ HTML æ–‡ä»¶åŒ…å«ï¼š

- ğŸ“Š **ç»Ÿè®¡æ¦‚è§ˆ** - äº‹ä»¶ç±»å‹åˆ†å¸ƒ
- ğŸ” **æœç´¢è¿‡æ»¤** - æŒ‰äº‹ä»¶ç±»å‹æˆ–å†…å®¹æœç´¢
- ğŸ“± **å“åº”å¼è®¾è®¡** - é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- ğŸ¨ **è¯­æ³•é«˜äº®** - ä»£ç å’Œ JSON å†…å®¹é«˜äº®
- ğŸ“‹ **è¯¦ç»†ä¿¡æ¯** - æ¯ä¸ªäº‹ä»¶çš„å®Œæ•´å…ƒæ•°æ®

### äº‹ä»¶é¢œè‰²ç¼–ç 

- ğŸ”µ ç”¨æˆ·æ¶ˆæ¯ - è“è‰²
- ğŸŸ£ åŠ©æ‰‹æ¶ˆæ¯ - ç´«è‰²
- ğŸŸ  æ€è€ƒæ¶ˆæ¯ - æ©™è‰²
- ğŸŸ¢ å·¥å…·è°ƒç”¨ - ç»¿è‰²
- ğŸŸ¡ å·¥å…·ç»“æœ - é»„ç»¿è‰²
- ğŸ”° è¿è¡Œå¼€å§‹ - é’è‰²
- ğŸ”´ è¿è¡Œç»“æŸ - ç²‰è‰²

## æ•°æ®ç»“æ„å¯¹æ¯”

è¯¦ç»†çš„åè®®å¯¹æ¯”åˆ†æè¯·å‚è€ƒ [event-stream-comparison.md](./event-stream-comparison.md)ã€‚

### å…³é”®å·®å¼‚

1. **äº‹ä»¶ç²’åº¦**ï¼šæºæ•°æ®ä½¿ç”¨ START/UPDATE/END ä¸‰é˜¶æ®µï¼Œç›®æ ‡åè®®ä½¿ç”¨å•ä¸€è¯­ä¹‰äº‹ä»¶
2. **æ—¶é—´æˆ³**ï¼šçº³ç§’ç²¾åº¦ â†’ æ¯«ç§’ç²¾åº¦
3. **å·¥å…·è°ƒç”¨**ï¼šæ–‡æœ¬åµŒå…¥æ ¼å¼ â†’ ç»“æ„åŒ–å¯¹è±¡
4. **äº‹ä»¶æ ‡è¯†**ï¼šspan_id + trace_id â†’ å•ä¸€ id

## æ‰©å±•å’Œè‡ªå®šä¹‰

### æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹

1. åœ¨ `transformer.ts` ä¸­æ·»åŠ æ–°çš„å¤„ç†é€»è¾‘
2. åœ¨ `dump-html.ts` ä¸­æ·»åŠ å¯¹åº”çš„ HTML ç”Ÿæˆé€»è¾‘
3. æ›´æ–°é¢œè‰²ç¼–ç å’Œæ ·å¼

### è‡ªå®šä¹‰ HTML æ¨¡æ¿

ä¿®æ”¹ `dump-html.ts` ä¸­çš„ `generateHTML` å‡½æ•°æ¥è‡ªå®šä¹‰ï¼š
- æ ·å¼å’Œå¸ƒå±€
- äº‹ä»¶å±•ç¤ºæ ¼å¼
- äº¤äº’åŠŸèƒ½

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ–‡ä»¶ä¸å­˜åœ¨é”™è¯¯**
   ```
   Error: agent_trace.jsonl not found
   ```
   ç¡®ä¿ `agent_trace.jsonl` æ–‡ä»¶å­˜åœ¨äºå½“å‰ç›®å½•ã€‚

2. **è§£æé”™è¯¯**
   ```
   Error parsing line: Unexpected token
   ```
   æ£€æŸ¥ JSONL æ–‡ä»¶æ ¼å¼ï¼Œç¡®ä¿æ¯è¡Œéƒ½æ˜¯æœ‰æ•ˆçš„ JSONã€‚

3. **ç±»å‹é”™è¯¯**
   ```
   TypeError: Cannot read property of undefined
   ```
   å¯èƒ½æ˜¯æºæ•°æ®ç»“æ„å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦æ›´æ–°è½¬æ¢å™¨é€»è¾‘ã€‚

### è°ƒè¯•æŠ€å·§

1. ä½¿ç”¨åˆ†æè„šæœ¬æ£€æŸ¥æºæ•°æ®ç»“æ„ï¼š
   ```bash
   node detailed_analyze.js 1
   ```

2. æŸ¥çœ‹è½¬æ¢åçš„åŸå§‹ JSONï¼š
   ```bash
   cat transformed_events.json | jq .
   ```

3. å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
   åœ¨è½¬æ¢å™¨ä¸­æ·»åŠ  `console.log` è¯­å¥è·Ÿè¸ªå¤„ç†è¿‡ç¨‹ã€‚

## æ€§èƒ½è€ƒè™‘

- å¤§æ–‡ä»¶å¤„ç†ï¼šå¯¹äºå¤§å‹ JSONL æ–‡ä»¶ï¼Œè€ƒè™‘ä½¿ç”¨æµå¼å¤„ç†
- å†…å­˜ä½¿ç”¨ï¼šè½¬æ¢å™¨ä¼šå°†æ‰€æœ‰äº‹ä»¶åŠ è½½åˆ°å†…å­˜ä¸­
- HTML ç”Ÿæˆï¼šå¤§é‡äº‹ä»¶å¯èƒ½å¯¼è‡´ HTML æ–‡ä»¶è¿‡å¤§

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªè½¬æ¢å™¨ï¼
