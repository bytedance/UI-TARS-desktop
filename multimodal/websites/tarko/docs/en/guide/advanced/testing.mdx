---
title: Testing
description: Testing strategies for Tarko Agents
---

# Testing

Testing Agents presents unique challenges due to their non-deterministic nature and complex interactions with external systems. Tarko provides several testing strategies and tools to ensure reliable Agent behavior.

## Testing Strategies

### Unit Testing

Test individual components in isolation:

```typescript
import { test, expect } from '@jest/globals';
import { WeatherTool } from './tools/weather';

test('WeatherTool should format location correctly', () => {
  const tool = new WeatherTool();
  const result = tool.formatLocation('san francisco, ca');
  expect(result).toBe('San Francisco, CA');
});
```

### Integration Testing

Test Agent interactions with tools:

```typescript
import { Agent } from '@tarko/agent';
import { MockWeatherTool } from './mocks';

test('should get weather information', async () => {
  const agent = new Agent({
    model: { provider: 'mock' },
    tools: [new MockWeatherTool()]
  });
  
  const response = await agent.chat('What\'s the weather in SF?');
  expect(response).toContain('72°F');
});
```

### End-to-End Testing

Test complete Agent workflows:

```typescript
import { Agent } from '@tarko/agent';
import { TestEnvironment } from '@tarko/testing';

test('complete file processing workflow', async () => {
  const env = new TestEnvironment();
  const agent = new Agent({
    model: { provider: 'mock' },
    tools: env.getTools()
  });
  
  // Setup test files
  await env.createFile('input.txt', 'test content');
  
  // Execute workflow
  const response = await agent.chat('Process the input.txt file');
  
  // Verify results
  expect(await env.fileExists('output.txt')).toBe(true);
  expect(response).toContain('processed successfully');
});
```

## Snapshot-Based Testing

Use snapshots for deterministic testing:

```typescript
import { loadSnapshot, Agent } from '@tarko/agent';

test('should handle complex scenario', async () => {
  // Load pre-recorded scenario
  const snapshot = await loadSnapshot('./test-data/complex-scenario.json');
  const agent = Agent.fromSnapshot(snapshot);
  
  // Test specific behavior
  const response = await agent.chat('Continue the task');
  
  // Assert expected outcome
  expect(response).toMatchSnapshot();
});
```

## Mocking

### Mock Tools

Create deterministic tool behavior:

```typescript
import { Tool } from '@tarko/agent';

class MockFileSystemTool implements Tool {
  name = 'read_file';
  description = 'Read file contents';
  
  private files = new Map<string, string>();
  
  async execute(params: { path: string }) {
    const content = this.files.get(params.path);
    if (!content) {
      throw new Error('File not found');
    }
    return { content };
  }
  
  // Test helper methods
  setFile(path: string, content: string) {
    this.files.set(path, content);
  }
}
```

### Mock Model Provider

Control model responses:

```typescript
import { ModelProvider } from '@tarko/agent';

class MockModelProvider implements ModelProvider {
  private responses: string[] = [];
  private responseIndex = 0;
  
  async generateResponse(messages: Message[]) {
    const response = this.responses[this.responseIndex];
    this.responseIndex = (this.responseIndex + 1) % this.responses.length;
    return { content: response };
  }
  
  // Test helper
  setResponses(responses: string[]) {
    this.responses = responses;
    this.responseIndex = 0;
  }
}
```

## Test Utilities

### Test Environment

Tarko provides a test environment for isolated testing:

```typescript
import { TestEnvironment } from '@tarko/testing';

const env = new TestEnvironment({
  filesystem: {
    initialFiles: {
      'config.json': '{ "setting": "value" }',
      'data.txt': 'sample data'
    }
  },
  network: {
    mockEndpoints: {
      'https://api.example.com/data': { status: 200, data: { result: 'success' } }
    }
  }
});

const agent = new Agent({
  model: { provider: 'mock' },
  tools: env.getTools(),
  environment: env
});
```

### Assertion Helpers

```typescript
import { expect } from '@tarko/testing';

// Custom matchers for Agent testing
expect(agent).toHaveCalledTool('read_file');
expect(agent).toHaveGeneratedEvents(['tool_call', 'tool_result']);
expect(response).toContainToolCall('search', { query: 'test' });
```

## Performance Testing

### Response Time Testing

```typescript
test('should respond within acceptable time', async () => {
  const start = Date.now();
  const response = await agent.chat('Simple question');
  const duration = Date.now() - start;
  
  expect(duration).toBeLessThan(5000); // 5 seconds
  expect(response).toBeDefined();
});
```

### Memory Usage Testing

```typescript
test('should not leak memory during long conversations', async () => {
  const initialMemory = process.memoryUsage().heapUsed;
  
  // Simulate long conversation
  for (let i = 0; i < 100; i++) {
    await agent.chat(`Message ${i}`);
  }
  
  // Force garbage collection
  global.gc();
  
  const finalMemory = process.memoryUsage().heapUsed;
  const memoryIncrease = finalMemory - initialMemory;
  
  // Should not increase significantly
  expect(memoryIncrease).toBeLessThan(50 * 1024 * 1024); // 50MB
});
```

## Continuous Integration

### GitHub Actions

```yaml
name: Agent Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run unit tests
      run: npm run test:unit
      
    - name: Run integration tests
      run: npm run test:integration
      env:
        TEST_MODEL_PROVIDER: mock
        
    - name: Run snapshot tests
      run: npm run test:snapshots
```

### Test Configuration

```json
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest --testPathPattern=unit",
    "test:integration": "jest --testPathPattern=integration",
    "test:snapshots": "jest --testPathPattern=snapshots",
    "test:watch": "jest --watch"
  },
  "jest": {
    "testEnvironment": "node",
    "setupFilesAfterEnv": ["<rootDir>/test/setup.js"],
    "testTimeout": 30000
  }
}
```

## Best Practices

### Test Organization

```
tests/
├── unit/
│   ├── tools/
│   └── utils/
├── integration/
│   ├── workflows/
│   └── tools/
├── snapshots/
│   ├── scenarios/
│   └── regression/
├── fixtures/
│   ├── snapshots/
│   └── data/
└── helpers/
    ├── mocks.js
    └── setup.js
```

### Test Data Management

```typescript
// Use consistent test data
const TEST_DATA = {
  files: {
    'sample.txt': 'This is sample content',
    'config.json': JSON.stringify({ key: 'value' })
  },
  responses: {
    weather: 'The weather is sunny, 72°F',
    error: 'I encountered an error processing your request'
  }
};
```

### Deterministic Testing

```typescript
// Seed random generators
Math.random = jest.fn(() => 0.5);

// Use fixed timestamps
Date.now = jest.fn(() => 1640995200000);

// Control async timing
jest.useFakeTimers();
```
