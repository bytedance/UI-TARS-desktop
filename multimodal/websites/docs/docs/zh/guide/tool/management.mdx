# Tool 管理

过滤、组织和优化 Agent 工具能力，针对特定任务和性能进行调优。

## 概述

@agent-tars/core 包含 **32 个内置工具**，分为 4 个类别：**general** (1)、**browser** (18)、**filesystem** (11) 和 **commands** (2)。Tool 管理允许你精确控制哪些工具可用，以优化性能和聚焦能力。

## 快速开始

```bash
# 仅包含浏览器工具（18 个工具）
tarko --tool.include browser

# 包含文件系统但排除文件编辑
tarko --tool.include filesystem --tool.exclude edit_file

# 多个类别并排除特定工具
tarko --tool.include "browser,filesystem" --tool.exclude "run_command,run_script"
```

## CLI Tool 过滤

### 可用选项

| 选项 | 描述 | 示例 |
|------|------|------|
| `--tool.include <patterns>` | 包含匹配模式的工具 | `--tool.include browser` |
| `--tool.exclude <patterns>` | 排除匹配模式的工具 | `--tool.exclude delete` |
| `--tool.list` | 列出所有可用工具 | `--tool.list` |
| `--tool.categories` | 显示工具分类 | `--tool.categories` |

### 模式匹配规则

- **子字符串匹配**：使用 `string.includes()` 实现高性能
- **大小写敏感**：模式必须匹配确切的大小写（`browser` 而不是 `Browser`）
- **执行顺序**：先应用包含过滤器，然后应用排除过滤器
- **分类名称**：使用分类名称进行批量操作

### 常见用例

#### 仅 Web 自动化
```bash
# 浏览器工具 + 网络搜索（19 个工具）
tarko --tool.include "browser,web_search"
```

#### 安全文件操作
```bash
# 文件系统但不执行命令（11 个工具）
tarko --tool.include filesystem --tool.exclude "run_command,run_script"
```

#### 只读 Agent
```bash
# 不允许文件写入或命令执行
tarko --tool.exclude "write_file,edit_file,create_directory,move_file,run_command,run_script"
```

#### 最小化 Agent
```bash
# 仅基本只读工具
tarko --tool.include "read_file,read_multiple_files,list_directory,browser_screenshot,web_search"
```

## 编程式 Tool 管理

### Agent 配置

```typescript
import { Agent } from '@agent-tars/core';

const agent = new Agent({
  tool: {
    include: ['browser', 'filesystem'],
    exclude: ['browser_get_markdown', 'run_command']
  }
});
```

### 配置文件

```json
{
  "tool": {
    "include": ["browser", "filesystem"],
    "exclude": ["delete", "remove"],
    "categories": {
      "browser": {
        "enabled": true,
        "exclude": ["browser_get_markdown"]
      },
      "filesystem": {
        "enabled": true,
        "exclude": ["move_file"]
      },
      "commands": {
        "enabled": false
      }
    }
  }
}
```

### 动态 Tool 管理

```typescript
import { Agent, ToolManager } from '@agent-tars/core';

const agent = new Agent();
const toolManager = agent.getToolManager();

// 运行时工具过滤
toolManager.filterTools({
  include: ['browser'],
  exclude: ['browser_close_tab']
});

// 添加自定义工具
toolManager.addTool(new CustomTool());

// 移除特定工具
toolManager.removeTool('browser_get_markdown');

// 获取活跃工具
const activeTools = toolManager.getActiveTools();
console.log(`活跃工具: ${activeTools.length}`);
```

## Tool 分类

### 内置分类

#### 📦 general (1 个工具)
- `web_search` - 搜索网络信息

#### 📦 browser (18 个工具)
- `browser_click` - 点击页面元素
- `browser_close_tab` - 关闭浏览器标签页
- `browser_evaluate` - 执行 JavaScript 代码
- `browser_form_input_fill` - 填写表单输入
- `browser_get_clickable_elements` - 获取可点击元素
- `browser_get_markdown` - 提取页面内容为 markdown
- `browser_go_back` - 在历史记录中后退
- `browser_go_forward` - 在历史记录中前进
- `browser_hover` - 悬停在元素上
- `browser_navigate` - 导航到 URL
- `browser_new_tab` - 打开新浏览器标签页
- `browser_press_key` - 按下键盘按键
- `browser_read_links` - 提取所有页面链接
- `browser_screenshot` - 截取页面截图
- `browser_scroll` - 滚动页面内容
- `browser_select` - 选择下拉选项
- `browser_switch_tab` - 在标签页间切换
- `browser_tab_list` - 列出所有打开的标签页

#### 📦 filesystem (11 个工具)
- `create_directory` - 创建新目录
- `directory_tree` - 获取目录结构
- `edit_file` - 编辑现有文件
- `get_file_info` - 获取文件元数据
- `list_allowed_directories` - 列出可访问目录
- `list_directory` - 列出目录内容
- `move_file` - 移动或重命名文件
- `read_file` - 读取文件内容
- `read_multiple_files` - 一次读取多个文件
- `search_files` - 按模式搜索文件
- `write_file` - 写入内容到文件

#### 📦 commands (2 个工具)
- `run_command` - 执行 shell 命令
- `run_script` - 运行脚本和解释器

### 自定义分类

```typescript
import { ToolCategory, Tool } from '@agent-tars/core';

export class DatabaseCategory implements ToolCategory {
  name = 'database';
  description = '数据库操作和查询';
  
  tools: Tool[] = [
    new QueryTool(),
    new InsertTool(),
    new UpdateTool(),
    new DeleteTool()
  ];
}

// 注册自定义分类
const agent = new Agent({
  toolCategories: [
    new DatabaseCategory()
  ]
});
```

## 性能优化

### Tool 加载策略

```typescript
// 重型工具的懒加载
const agent = new Agent({
  tool: {
    loadingStrategy: 'lazy',
    include: ['browser'],
    preload: ['browser_navigate', 'browser_screenshot']
  }
});
```

### 内存管理

```typescript
// Tool 实例池
const agent = new Agent({
  tool: {
    pooling: {
      enabled: true,
      maxInstances: 5,
      idleTimeout: 30000 // 30 秒
    }
  }
});
```

### 执行限制

```typescript
// 为每个工具设置执行限制
const agent = new Agent({
  tool: {
    limits: {
      'run_command': {
        timeout: 10000, // 10 秒
        maxConcurrent: 1
      },
      'browser_screenshot': {
        timeout: 5000,
        maxConcurrent: 3
      }
    }
  }
});
```

## 安全和权限

### Tool 权限

```typescript
const agent = new Agent({
  tool: {
    permissions: {
      'run_command': {
        allowedCommands: ['ls', 'pwd', 'cat'],
        blockedCommands: ['rm', 'sudo', 'chmod']
      },
      'write_file': {
        allowedPaths: ['/tmp', '/workspace'],
        blockedPaths: ['/etc', '/usr', '/system']
      }
    }
  }
});
```

### 沙箱化

```typescript
// 启用工具沙箱
const agent = new Agent({
  tool: {
    sandbox: {
      enabled: true,
      isolateFileSystem: true,
      isolateNetwork: false,
      allowedDomains: ['api.example.com']
    }
  }
});
```

## 监控和分析

### Tool 使用跟踪

```typescript
import { ToolMonitor } from '@agent-tars/core';

const monitor = new ToolMonitor();

monitor.on('toolExecuted', (event) => {
  console.log(`工具 ${event.toolName} 执行耗时 ${event.duration}ms`);
});

monitor.on('toolError', (event) => {
  console.error(`工具 ${event.toolName} 失败: ${event.error}`);
});

const agent = new Agent({
  monitor
});
```

### 性能指标

```typescript
// 获取工具性能指标
const metrics = await agent.getToolMetrics();

console.log('Tool 使用统计:');
metrics.forEach(metric => {
  console.log(`${metric.toolName}: ${metric.executionCount} 次调用，平均 ${metric.averageDuration}ms`);
});
```

## 故障排除

### 调试 Tool 过滤

```bash
# 查看哪些工具被过滤
tarko --debug --tool.include browser
# 输出: "应用包含过滤器，模式 [browser]，32/32 工具中匹配了 18 个"
```

### 常见问题

#### 没有可用工具
```bash
# 检查可用工具
tarko --tool.list

# 使用更宽泛的模式
tarko --tool.exclude "run_command" # 排除特定工具而不是严格包含
```

#### 模式不工作
- 验证大小写敏感性（`browser` 而不是 `Browser`）
- 使用确切的工具名称（`browser_click` 而不是 `click`）
- 检查分类名称：`browser`、`filesystem`、`commands`、`general`

#### Tool 加载错误
```typescript
try {
  const agent = new Agent({
    tool: { include: ['invalid_tool'] }
  });
} catch (error) {
  console.error('工具加载失败:', error.message);
  // 回退到默认工具
}
```

### 日志和调试

```typescript
import { Agent, LogLevel } from '@agent-tars/core';

const agent = new Agent({
  logging: {
    level: LogLevel.DEBUG,
    categories: ['tool-manager', 'tool-execution']
  }
});
```

## 高级模式

### 条件 Tool 加载

```typescript
const agent = new Agent({
  tool: {
    conditional: {
      'run_command': {
        condition: () => process.env.NODE_ENV === 'development',
        fallback: 'safe_command'
      }
    }
  }
});
```

### Tool 组合

```typescript
// 将工具组合成工作流
const workflow = new ToolWorkflow([
  'browser_navigate',
  'browser_screenshot',
  'write_file'
]);

const agent = new Agent({
  workflows: [workflow]
});
```

### 插件系统

```typescript
// 用于扩展性的工具插件
const toolPlugin = {
  name: 'database-tools',
  version: '1.0.0',
  tools: [
    new QueryTool(),
    new MigrationTool()
  ]
};

const agent = new Agent({
  plugins: [toolPlugin]
});
```

## 下一步

- 了解 [Tool 开发](/guide/tool/basic) 来创建自定义工具
- 探索 [Tool Call Engine](/guide/tool/tool-call-engine) 的执行优化

{/* Placeholder: 添加工具管理仪表板截图 */}
{/* Placeholder: 添加性能监控图表 */}