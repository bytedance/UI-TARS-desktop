# Model Provider 配置

Tarko Agent Server 支持灵活的多模型配置，允许在同一应用中使用不同的 AI 模型，并在运行时动态切换。

## 配置概览

模型配置系统支持两种主要方式：

1. **Agent 级别配置**：通过 `AgentOptions.model` - 支持单一模型配置
2. **Server 级别配置**：通过 `server.models` - 支持多个模型配置

这些配置在运行时合并，提供统一的模型选择界面。

## 配置场景

### 单模型配置

通过 `AgentOptions.model` 配置单个模型：

```typescript
const agentOptions = {
  model: {
    id: "gpt-4",
    provider: "openai",
    displayName: "GPT-4"
  },
  workspace: "/path/to/workspace"
}
```

**行为特征：**
- UI 显示静态模型信息：`GPT-4 • openai`
- 不显示模型选择器下拉菜单
- 所有会话使用配置的模型

### 多模型配置

通过 `server.models` 配置多个模型：

```typescript
const serverOptions = {
  workspace: "/path/to/workspace",
  server: {
    models: [
      { id: "gpt-4", provider: "openai", displayName: "GPT-4" },
      { id: "claude-3-opus", provider: "anthropic", displayName: "Claude 3 Opus" },
      { id: "gemini-pro", provider: "google", displayName: "Gemini Pro" }
    ]
  }
}
```

**行为特征：**
- UI 显示模型选择器下拉菜单
- 默认选择：`server.models` 中的第一个模型
- 用户可以在可用模型间切换
- 每个会话独立记住选择的模型

### 混合配置（推荐）

结合两种方式以获得最大灵活性：

```typescript
const config = {
  model: { 
    id: "gpt-3.5-turbo", 
    provider: "openai", 
    displayName: "GPT-3.5 Turbo" 
  },
  workspace: "/path/to/workspace",
  server: {
    models: [
      { id: "gpt-4", provider: "openai", displayName: "GPT-4" },
      { id: "claude-3-sonnet", provider: "anthropic", displayName: "Claude 3 Sonnet" }
    ]
  }
}
```

**行为特征：**
- 可用模型：`[gpt-3.5-turbo, gpt-4, claude-3-sonnet]`（合并并去重）
- 默认模型：`gpt-3.5-turbo`（`AgentOptions.model` 优先级更高）
- UI 显示包含所有可用模型的选择器



## API 参考

### 获取可用模型

```http
GET /api/v1/models
```

**响应：**
```json
{
  "models": [
    {
      "id": "gpt-4",
      "provider": "openai",
      "displayName": "GPT-4"
    },
    {
      "id": "gpt-3.5-turbo",
      "provider": "openai",
      "displayName": "GPT-3.5 Turbo"
    },
    {
      "id": "claude-3-opus",
      "provider": "anthropic",
      "displayName": "Claude 3 Opus"
    }
  ]
}
```

### 更新会话模型

```http
POST /api/v1/sessions/model
Content-Type: application/json

{
  "sessionId": "session-123",
  "model": {
    "id": "claude-3-opus",
    "provider": "anthropic",
    "displayName": "Claude 3 Opus"
  }
}
```

**响应：**
```json
{
  "success": true,
  "sessionInfo": {
    "id": "session-123",
    "metadata": {
      "modelConfig": {
        "id": "claude-3-opus",
        "provider": "anthropic",
        "displayName": "Claude 3 Opus"
      }
    }
  }
}
```

## 最佳实践

1. **使用混合配置**：在生产部署中提供默认模型和备选模型
2. **验证模型可用性**：在部署配置更改前验证模型可用性
3. **监控模型使用情况**：通过会话元数据了解用户偏好
4. **优雅处理回退**：当配置的模型不可用时优雅处理
5. **缓存模型列表**：在前端缓存模型列表以减少模型切换时的 API 调用